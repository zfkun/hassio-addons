name: Sync go2rtc (HA arch images)

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Get latest upstream release
        id: upstream
        run: |
          tag=$(curl -s https://api.github.com/repos/AlexxIT/go2rtc/releases/latest | jq -r .tag_name)
          echo "tag=${tag#v}" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            skopeo login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      - name: Sync per-arch images
        run: |
          TAG=${{ steps.upstream.outputs.tag }}

          # 检查TAG是否有效
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "ERROR: Invalid tag received: $TAG"
            exit 1
          fi

          echo "Checking upstream image manifest for tag: $TAG"
          echo "=== Docker manifest inspect ==="
          docker manifest inspect docker.io/alexxit/go2rtc:${TAG} | jq '.' || echo "Manifest inspect failed"
          echo "==============================="

          declare -A ARCH_MAP=(
            [amd64]="linux/amd64"
            [aarch64]="linux/arm64"
            [armv7]="linux/arm/v7"  # 需要特殊处理
            [armhf]="linux/arm/v6"  # 需要特殊处理
            [i386]="linux/386"
          )
        
          # 定义 skopeo 参数映射
          declare -A SKEPO_PARAMS=(
            [amd64]="--override-os linux --override-arch amd64"
            [aarch64]="--override-os linux --override-arch arm64"
            [armv7]="--override-os linux --override-arch arm --override-variant v7"
            [armhf]="--override-os linux --override-arch arm --override-variant v6"
            [i386]="--override-os linux --override-arch 386"
          )

          for arch in "${!ARCH_MAP[@]}"; do
            target="ghcr.io/zfkun/${arch}-hass-addon-go2rtc:${TAG}"
            latest_target="ghcr.io/zfkun/${arch}-hass-addon-go2rtc:latest"

            # 避免覆盖旧版本
            if skopeo inspect docker://$target >/dev/null 2>&1; then
              echo "✔ $arch already exists, skip"

              # 即使版本已存在，也要确保 latest 标签也存在
              if ! skopeo inspect docker://$latest_target >/dev/null 2>&1; then
                echo "→ creating latest tag for $arch"
                skopeo copy \
                  $(echo ${SKEPO_PARAMS[$arch]}) \
                  docker://docker.io/alexxit/go2rtc:${TAG} \
                  docker://$latest_target
              fi

              continue
            fi

            echo "Checking availability of $arch (${ARCH_MAP[$arch]}) in upstream..."

            if ! skopeo inspect docker://docker.io/alexxit/go2rtc:${TAG} \
                ${SKEPO_PARAMS[$arch]} >/dev/null 2>&1; then
              echo "⚠ $arch not available in upstream, skip"
              continue
            fi

            echo "→ syncing $arch"
            skopeo copy \
              $(echo ${SKEPO_PARAMS[$arch]}) \
              docker://docker.io/alexxit/go2rtc:${TAG} \
              docker://$target

            # 同步对应的 latest 标签
            skopeo copy \
              ${SKEPO_PARAMS[$arch]} \
              docker://docker.io/alexxit/go2rtc:${TAG} \
              docker://$latest_target
          done

      - name: Bump add-on version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查TAG是否有效
          TAG="${{ steps.upstream.outputs.tag }}"
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "ERROR: Invalid tag received: $TAG, exiting without changes."
            exit 1
          fi

          # 检查当前版本是否与最新版本相同
          CURRENT_VERSION=$(grep "^version:" go2rtc/config.yaml | sed 's/version: "\(.*\)"/\1/')
          LATEST_VERSION="$TAG"

          echo "Current version: $CURRENT_VERSION"
          echo "Latest version: $LATEST_VERSION"

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "Version is already up to date, skipping commit."
            exit 0
          fi

          sed -i 's/^version:.*/version: "'$LATEST_VERSION'"/' go2rtc/config.yaml
          git add go2rtc/config.yaml

          # 检查是否有实际更改
          if ! git diff --quiet HEAD; then
            git commit -m "go2rtc: bump version to $LATEST_VERSION [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
